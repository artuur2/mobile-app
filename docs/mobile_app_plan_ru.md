# План запуска мобильного приложения: астрология, натальные карты, медитации

## 1) Цели продукта
- Персональные астрологические прогнозы: на день, 3 дня, неделю, месяц.
- Натальная карта и интерпретации по ключевым домам/аспектам.
- Тематические прогнозы: любовь, карьера, финансы, здоровье, энергия, отношения.
- Контент медитаций (аудио/текст) с подборкой под состояние пользователя.
- Монетизация через подписку + ограничения бесплатного тарифа.

## 2) Платформенная стратегия
### Этап 1 (MVP): Android
- Нативная Android-разработка на **Kotlin + Jetpack Compose**.
- Minimum SDK: 26+ (Android 8.0+) для покрытия и современных API.

### Этап 2: iOS
- Опция A (рекомендуется): миграция на **Kotlin Multiplatform Mobile (KMM)** для шаринга доменной логики/SDK.
- Опция B: отдельный iOS-клиент на SwiftUI, если приоритет — максимально нативный UX.

## 3) Технологический стек

## 3.1 Android-клиент
- Язык: Kotlin.
- UI: Jetpack Compose.
- Архитектура: Clean Architecture + MVVM.
- DI: Hilt.
- Навигация: Navigation Compose.
- Сеть: Retrofit + OkHttp + Kotlinx Serialization.
- Локальное хранение: Room + EncryptedSharedPreferences.
- Фоновые задачи: WorkManager (обновление прогнозов/кеша).
- Аналитика/краши: Firebase Analytics + Crashlytics.
- Push: Firebase Cloud Messaging.

## 3.2 Backend (сервер)
- API: REST (MVP), далее можно добавить GraphQL для гибкого клиентского чтения.
- Язык backend: **Node.js (NestJS)** или **Go (Gin/Fiber)** — оба подходят; для быстрого старта команды часто выбирают NestJS.
- БД: PostgreSQL.
- Кеш: Redis.
- Хранилище медиа: S3-совместимое (AWS S3/MinIO).
- Очереди задач: BullMQ / RabbitMQ (генерация прогнозов, email, нотификации).
- Контейнеризация: Docker + Kubernetes (или ECS/Fargate на старте).

## 3.3 ML/астрологический движок
- Отдельный сервис генерации интерпретаций (правила + LLM/шаблоны).
- Версионирование промптов/шаблонов и контроль качества ответов.
- Логи качества и A/B эксперименты для текстов прогнозов.

## 4) Модель подписок и доступов
### Бесплатная версия
- Ограниченный ежедневный прогноз (например, 1 тема/день).
- Натальная карта — базовая, без подробной расшифровки аспектов.
- Ограниченный каталог медитаций (например, 5 треков).
- Ограничение истории (последние 7 дней).

### Платная подписка (Monthly/Yearly)
- Все темы прогнозов + длинные горизонты (3 дня, неделя, месяц).
- Расширенные натальные интерпретации.
- Полный каталог медитаций + персональные подборки.
- Приоритетные фичи и ранний доступ.

## 5) Безопасность и защита платного контента

## 5.1 Ключевой принцип
**Никогда не доверять клиенту.**
- Android-приложение только отображает данные.
- Проверка подписки, прав доступа и лимитов — только на сервере.

## 5.2 Что обязательно сделать
1. **Server-side entitlement check**
   - Каждый платный endpoint проверяет активную подписку пользователя на сервере.
2. **Валидация покупок**
   - Android: Google Play Billing + серверная валидация purchase token через Google API.
   - Использовать Real-time Developer Notifications для синхронизации статусов.
3. **Короткоживущие JWT + refresh token**
   - Access token 10–15 мин, refresh в защищенном хранилище.
4. **Подпись запросов и rate limiting**
   - Защита от скриптов/абьюза.
5. **Шифрование в транзите и в покое**
   - TLS 1.2+, шифрование БД-бэкапов и чувствительных полей.
6. **Device integrity**
   - Play Integrity API/SafetyNet-проверки, риск-скоринг устройства.
7. **Антифрод-правила**
   - Аномалии: частые смены устройств, массовые запросы платных endpoint.

## 5.3 Что не делать
- Не хранить «флаг премиума» только локально в приложении.
- Не отдавать весь премиум-контент заранее в кеш на устройство.
- Не полагаться только на obfuscation как на защиту монетизации.

## 6) API-контракты (MVP)
- `POST /auth/login` / `POST /auth/refresh`
- `GET /profile`
- `GET /subscription/status`
- `POST /subscription/google/verify`
- `GET /forecasts?period=day|3days|week|month&topic=...`
- `GET /natal-chart`
- `GET /meditations`
- `POST /events/track`

Ответы API должны уже быть отфильтрованы по entitlement (free/premium).

## 7) Дорожная карта
### Спринт 0 (1–2 недели)
- Product discovery, UX-скелет, карта контента.
- Согласование paywall-стратегии и тарифов.
- Проектирование БД и API.

### Спринт 1–2 (3–4 недели)
- Android MVP: onboarding, auth, профиль, базовый прогноз.
- Сервер: auth, billing verify, subscription status, forecast endpoint.
- Базовый paywall + лимиты free.

### Спринт 3–4 (3–4 недели)
- Натальная карта + расширенные интерпретации.
- Медитации (каталог + player).
- Push-уведомления и retention-сценарии.

### Спринт 5 (2 недели)
- Усиление безопасности, антифрод, нагрузочное тестирование.
- App Store/Play Store подготовка, legal/privacy.

## 8) Метрики успеха
- Conversion free → paid.
- D1/D7/D30 retention.
- ARPU / LTV.
- Churn rate подписки.
- Crash-free sessions > 99.5%.
- Доля отклоненных/фродовых покупок.

## 9) Что можно делать прямо сейчас
1. Утвердить стек: Kotlin + Compose + NestJS + PostgreSQL.
2. Зафиксировать тарифы и лимиты бесплатного доступа.
3. Согласовать схему entitlement-проверок на сервере.
4. Подготовить API-спеку (OpenAPI) и начать Android MVP.
